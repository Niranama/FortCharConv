
SUBMODULE (Class_BaseRNG) SubClass_Rng_Ziggurate
       
!** PURPOSE OF THIS MODULE:
    ! This submodule contains modified-ziggurat implementation of 'NextGaussian'
    ! and 'NextExponential' procedures based on McFarland's fast modified ziggurat
    ! algorithm and Walker's alias method for sampling a discrete distribution.

    !** REFERENCES:
    ! [1] Christopher D. McFarland.  2016.  A modified ziggurat algorithm for
    ! generating exponentially and normally distributed pseudorandom numbers.
    ! Journal of Statistical Computation and Simulation 86 (7), pages 1281-1294.
    ! https:!www.tandfonline.com/doi/abs/10.1080/00949655.2015.1060234
    ! Also at https:!arxiv.org/abs/1403.6870 (26 March 2014).
    ! [2] Alastair J. Walker.  1977.  An efficient method for generating discrete random
    ! variables with general distributions. ACM Trans. Math. Software 3, 3
    ! (September 1977), 253-256. DOI: https:!doi.org/10.1145/355744.355749

!** MODULE PARAMETERS:
    REAL(KIND=DP), PARAMETER  :: Multiplier = 2.0_DP**63

    ! Implementation support for modified-ziggurat implementation of  nextExponential()
    !
    ! Fraction of the area under the curve that lies outside the layer
    ! boxes: 0.0156 Fraction of non-box area that lies in the tail of the
    ! distribution: 0.0330

    INTEGER(KIND=I4B), PARAMETER :: ExponentialNumberOfLayers = 252
    INTEGER(KIND=I4B), PARAMETER :: ExponentialLayerMask = INT(Z'000000FF', KIND=I4B)
    INTEGER(KIND=I4B), PARAMETER :: ExponentialAliasMask = INT(Z'000000FF', KIND=I4B)
    INTEGER(KIND=I4B), PARAMETER :: ExponentialSignCorrectionMask = INT(Z'000000FF', KIND=I4B)
    REAL(KIND=DP),     PARAMETER :: ExponentialX0 = 7.56927469414806264_DP
    INTEGER(KIND=I8B), PARAMETER :: ExponentialConvexMargin = 853965788476313645_I8B   ! unscaled convex margin = 0.0926

    ! Exponential_NormalX(i] = length of ziggurat layer i for Exponential distribution, scaled by 2**(-63)
    REAL(KIND=DP),     PARAMETER :: ExponentialX(0:252) = [ &      ! 253 entries, which is Exponential_number_of_layers+1
        8.2066240675348816D-19,  7.3973732351607284D-19,  6.9133313377915293D-19,  6.5647358820964533D-19, &
        6.2912539959818508D-19,  6.0657224129604964D-19,  5.8735276103737269D-19,  5.7058850528536941D-19, &
        5.5570945691622390D-19,  5.4232438903743953D-19,  5.3015297696508776D-19,  5.1898739257708062D-19, &
        5.0866922617998330D-19,  4.9907492938796469D-19,  4.9010625894449536D-19,  4.8168379010649187D-19, &
        4.7374238653644714D-19,  4.6622795807196824D-19,  4.5909509017784048D-19,  4.5230527790658154D-19, &
        4.4582558816353960D-19,  4.3962763126368381D-19,  4.3368675967106470D-19,  4.2798143618469714D-19, &
        4.2249273027064889D-19,  4.1720391253464110D-19,  4.1210012522465616D-19,  4.0716811225869233D-19, &
        4.0239599631006903D-19,  3.9777309342877357D-19,  3.9328975785334499D-19,  3.8893725129310323D-19, &
        3.8470763218720385D-19,  3.8059366138180143D-19,  3.7658872138544730D-19,  3.7268674692030177D-19, &
        3.6888216492248162D-19,  3.6516984248800068D-19,  3.6154504153287473D-19,  3.5800337915318032D-19, &
        3.5454079284533432D-19,  3.5115350988784242D-19,  3.4783802030030962D-19,  3.4459105288907336D-19, &
        3.4140955396563316D-19,  3.3829066838741162D-19,  3.3523172262289001D-19,  3.3223020958685874D-19, &
        3.2928377502804472D-19,  3.2639020528202049D-19,  3.2354741622810815D-19,  3.2075344331080789D-19, &
        3.1800643250478609D-19,  3.1530463211820845D-19,  3.1264638534265134D-19,  3.1003012346934211D-19, &
        3.0745435970137301D-19,  3.0491768350005559D-19,  3.0241875541094565D-19,  2.9995630232144550D-19, &
        2.9752911310742592D-19,  2.9513603463113224D-19,  2.9277596805684267D-19,  2.9044786545442563D-19, &
        2.8815072666416712D-19,  2.8588359639906928D-19,  2.8364556156331615D-19,  2.8143574876779799D-19, &
        2.7925332202553125D-19,  2.7709748061152879D-19,  2.7496745707320232D-19,  2.7286251537873397D-19, &
        2.7078194919206054D-19,  2.6872508026419050D-19,  2.6669125693153442D-19,  2.6467985271278891D-19, &
        2.6269026499668434D-19,  2.6072191381359757D-19,  2.5877424068465143D-19,  2.5684670754248168D-19, &
        2.5493879571835479D-19,  2.5305000499077481D-19,  2.5117985269112710D-19,  2.4932787286227806D-19, &
        2.4749361546638660D-19,  2.4567664563848669D-19,  2.4387654298267842D-19,  2.4209290090801527D-19, &
        2.4032532600140538D-19,  2.3857343743505147D-19,  2.3683686640614648D-19,  2.3511525560671253D-19, &
        2.3340825872163284D-19,  2.3171553995306794D-19,  2.3003677356958333D-19,  2.2837164347843482D-19, &
        2.2671984281957174D-19,  2.2508107358001938D-19,  2.2345504622739592D-19,  2.2184147936140775D-19, &
        2.2024009938224424D-19,  2.1865064017486842D-19,  2.1707284280826716D-19,  2.1550645524878675D-19, &
        2.1395123208673778D-19,  2.1240693427550640D-19,  2.1087332888245875D-19,  2.0935018885097035D-19, &
        2.0783729277295508D-19,  2.0633442467130712D-19,  2.0484137379170616D-19,  2.0335793440326865D-19, &
        2.0188390560756090D-19,  2.0041909115551697D-19,  1.9896329927183254D-19,  1.9751634248643090D-19, &
        1.9607803747261946D-19,  1.9464820489157862D-19,  1.9322666924284314D-19,  1.9181325872045647D-19, &
        1.9040780507449479D-19,  1.8901014347767504D-19,  1.8762011239677479D-19,  1.8623755346860768D-19, &
        1.8486231138030984D-19,  1.8349423375370566D-19,  1.8213317103353295D-19,  1.8077897637931708D-19, &
        1.7943150556069476D-19,  1.7809061685599652D-19,  1.7675617095390567D-19,  1.7542803085801941D-19, &
        1.7410606179414531D-19,  1.7279013112017240D-19,  1.7148010823836362D-19,  1.7017586450992059D-19, &
        1.6887727317167824D-19,  1.6758420925479093D-19,  1.6629654950527621D-19,  1.6501417230628659D-19, &
        1.6373695760198277D-19,  1.6246478682288560D-19,  1.6119754281258616D-19,  1.5993510975569615D-19, &
        1.5867737310692309D-19,  1.5742421952115544D-19,  1.5617553678444595D-19,  1.5493121374578016D-19, &
        1.5369114024951992D-19,  1.5245520706841019D-19,  1.5122330583703858D-19,  1.4999532898563561D-19, &
        1.4877116967410352D-19,  1.4755072172615974D-19,  1.4633387956347966D-19,  1.4512053813972103D-19, &
        1.4391059287430991D-19,  1.4270393958586506D-19,  1.4150047442513381D-19,  1.4030009380730888D-19, &
        1.3910269434359025D-19,  1.3790817277185197D-19,  1.3671642588626657D-19,  1.3552735046573446D-19, &
        1.3434084320095729D-19,  1.3315680061998685D-19,  1.3197511901207148D-19,  1.3079569434961214D-19, &
        1.2961842220802957D-19,  1.2844319768333099D-19,  1.2726991530715219D-19,  1.2609846895903523D-19, &
        1.2492875177568625D-19,  1.2376065605693940D-19,  1.2259407316813331D-19,  1.2142889343858445D-19, &
        1.2026500605581765D-19,  1.1910229895518744D-19,  1.1794065870449425D-19,  1.1677997038316715D-19, &
        1.1562011745554883D-19,  1.1446098163777869D-19,  1.1330244275772562D-19,  1.1214437860737343D-19, &
        1.1098666478700728D-19,  1.0982917454048923D-19,  1.0867177858084351D-19,  1.0751434490529747D-19, &
        1.0635673859884002D-19,  1.0519882162526621D-19,  1.0404045260457141D-19,  1.0288148657544097D-19, &
        1.0172177474144965D-19,  1.0056116419943559D-19,  9.9399497648346677D-20,  9.8236613076667446D-20, &
        9.7072343426320094D-20,  9.5906516230690634D-20,  9.4738953224154196D-20,  9.3569469920159036D-20, &
        9.2397875154569468D-20,  9.1223970590556472D-20,  9.0047550180852874D-20,  8.8868399582647627D-20, &
        8.7686295519767450D-20,  8.6501005086071005D-20,  8.5312284983141187D-20,  8.4119880684385214D-20, &
        8.2923525516513420D-20,  8.1722939648034506D-20,  8.0517828972839211D-20,  7.9307883875099226D-20, &
        7.8092777859524425D-20,  7.6872166028429042D-20,  7.5645683383965122D-20,  7.4412942930179128D-20, &
        7.3173533545093332D-20,  7.1927017587631075D-20,  7.0672928197666785D-20,  6.9410766239500362D-20, &
        6.8139996829256425D-20,  6.6860045374610234D-20,  6.5570293040210081D-20,  6.4270071533368528D-20, &
        6.2958657080923559D-20,  6.1635263438143136D-20,  6.0299033732151700D-20,  5.8949030892850181D-20, &
        5.7584226359885930D-20,  5.6203486669597397D-20,  5.4805557413499315D-20,  5.3389043909003295D-20, &
        5.1952387717989917D-20,  5.0493837866338355D-20,  4.9011415222629489D-20,  4.7502867933366117D-20, &
        4.5965615001265455D-20,  4.4396673897997565D-20,  4.2792566302148588D-20,  4.1149193273430015D-20, &
        3.9461666762606287D-20,  3.7724077131401685D-20,  3.5929164086204360D-20,  3.4067836691100565D-20, &
        3.2128447641564046D-20,  3.0095646916399994D-20,  2.7948469455598328D-20,  2.5656913048718645D-20, &
        2.3175209756803909D-20,  2.0426695228251291D-20,  1.7261770330213485D-20,  1.3281889259442578D-20, &
        0.0000000000000000D+00]

    ! Exponential_NormalY(i] = value of the Exponential distribution function at Exponential_NormalX(i], scaled by 2**(-63)
    REAL(KIND=DP),     PARAMETER :: ExponentialY(0:252) = [ &      ! 253 entries, which is Exponential_number_of_layers+1
        5.5952054951127360D-23,  1.1802509982703313D-22,  1.8444423386735829D-22,  2.5439030466698309D-22, &
        3.2737694311509334D-22,  4.0307732132706715D-22,  4.8125478319495115D-22,  5.6172914896583308D-22, &
        6.4435820540443526D-22,  7.2902662343463681D-22,  8.1563888456321941D-22,  9.0411453683482223D-22, &
        9.9438488486399206D-22,  1.0863906045969114D-21,  1.1800799775461269D-21,  1.2754075534831208D-21, &
        1.3723331176377290D-21,  1.4708208794375214D-21,  1.5708388257440445D-21,  1.6723581984374566D-21, &
        1.7753530675030514D-21,  1.8797999785104595D-21,  1.9856776587832504D-21,  2.0929667704053244D-21, &
        2.2016497009958240D-21,  2.3117103852306179D-21,  2.4231341516125464D-21,  2.5359075901420891D-21, &
        2.6500184374170538D-21,  2.7654554763660391D-21,  2.8822084483468604D-21,  3.0002679757547711D-21, &
        3.1196254936130377D-21,  3.2402731888801749D-21,  3.3622039464187092D-21,  3.4854113007409036D-21, &
        3.6098893927859475D-21,  3.7356329310971768D-21,  3.8626371568620053D-21,  3.9908978123552837D-21, &
        4.1204111123918948D-21,  4.2511737184488913D-21,  4.3831827151633737D-21,  4.5164355889510656D-21, &
        4.6509302085234806D-21,  4.7866648071096003D-21,  4.9236379662119969D-21,  5.0618486007478993D-21, &
        5.2012959454434732D-21,  5.3419795423648946D-21,  5.4838992294830959D-21,  5.6270551301806347D-21, &
        5.7714476436191935D-21,  5.9170774358950678D-21,  6.0639454319177027D-21,  6.2120528079531677D-21, &
        6.3614009847804375D-21,  6.5119916214136427D-21,  6.6638266093481696D-21,  6.8169080672926277D-21, &
        6.9712383363524377D-21,  7.1268199756340822D-21,  7.2836557582420336D-21,  7.4417486676430174D-21, &
        7.6011018943746355D-21,  7.7617188330775411D-21,  7.9236030798322572D-21,  8.0867584297834842D-21, &
        8.2511888750363333D-21,  8.4168986028103258D-21,  8.5838919938383098D-21,  8.7521736209986459D-21, &
        8.9217482481700712D-21,  9.0926208292996504D-21,  9.2647965076751277D-21,  9.4382806153938292D-21, &
        9.6130786730210328D-21,  9.7891963894314161D-21,  9.9666396618278840D-21,  1.0145414575932636D-20, &
        1.0325527406345955D-20,  1.0506984617068672D-20,  1.0689792862184811D-20,  1.0873958986701341D-20, &
        1.1059490027542400D-20,  1.1246393214695825D-20,  1.1434675972510121D-20,  1.1624345921140471D-20, &
        1.1815410878142659D-20,  1.2007878860214202D-20,  1.2201758085082226D-20,  1.2397056973538040D-20, &
        1.2593784151618565D-20,  1.2791948452935152D-20,  1.2991558921150600D-20,  1.3192624812605428D-20, &
        1.3395155599094805D-20,  1.3599160970797774D-20,  1.3804650839360727D-20,  1.4011635341137284D-20, &
        1.4220124840587164D-20,  1.4430129933836705D-20,  1.4641661452404201D-20,  1.4854730467093280D-20, &
        1.5069348292058084D-20,  1.5285526489044050D-20,  1.5503276871808626D-20,  1.5722611510726402D-20, &
        1.5943542737583543D-20,  1.6166083150566702D-20,  1.6390245619451956D-20,  1.6616043290999594D-20, &
        1.6843489594561079D-20,  1.7072598247904713D-20,  1.7303383263267072D-20,  1.7535858953637607D-20, &
        1.7770039939284241D-20,  1.8005941154528286D-20,  1.8243577854777398D-20,  1.8482965623825808D-20, &
        1.8724120381431627D-20,  1.8967058391181452D-20,  1.9211796268653192D-20,  1.9458350989888484D-20, &
        1.9706739900186868D-20,  1.9956980723234356D-20,  2.0209091570579904D-20,  2.0463090951473895D-20, &
        2.0718997783083593D-20,  2.0976831401101350D-20,  2.1236611570762130D-20,  2.1498358498287976D-20, &
        2.1762092842777868D-20,  2.2027835728562592D-20,  2.2295608758045219D-20,  2.2565434025049041D-20, &
        2.2837334128696004D-20,  2.3111332187840010D-20,  2.3387451856080863D-20,  2.3665717337386111D-20, &
        2.3946153402349610D-20,  2.4228785405117410D-20,  2.4513639301013211D-20,  2.4800741664897764D-20, &
        2.5090119710298442D-20,  2.5381801309347597D-20,  2.5675815013570500D-20,  2.5972190075566336D-20, &
        2.6270956471628253D-20,  2.6572144925351523D-20,  2.6875786932281841D-20,  2.7181914785659148D-20, &
        2.7490561603315974D-20,  2.7801761355793055D-20,  2.8115548895739172D-20,  2.8431959988666534D-20, &
        2.8751031345137833D-20,  2.9072800654466307D-20,  2.9397306620015486D-20,  2.9724588996191657D-20, &
        3.0054688627228112D-20,  3.0387647487867642D-20,  3.0723508726057078D-20,  3.1062316707775905D-20, &
        3.1404117064129991D-20,  3.1748956740850969D-20,  3.2096884050352357D-20,  3.2447948726504914D-20, &
        3.2802201982306013D-20,  3.3159696570631373D-20,  3.3520486848272230D-20,  3.3884628843476888D-20, &
        3.4252180327233346D-20,  3.4623200888548644D-20,  3.4997752014001677D-20,  3.5375897171869060D-20, &
        3.5757701901149035D-20,  3.6143233905835799D-20,  3.6532563154827400D-20,  3.6925761987883572D-20, &
        3.7322905228086981D-20,  3.7724070301302117D-20,  3.8129337363171041D-20,  3.8538789434235234D-20, &
        3.8952512543827862D-20,  3.9370595883442399D-20,  3.9793131970351439D-20,  4.0220216822325769D-20, &
        4.0651950144388133D-20,  4.1088435528630944D-20,  4.1529780668232712D-20,  4.1976097586926582D-20, &
        4.2427502885307452D-20,  4.2884118005513604D-20,  4.3346069515987453D-20,  4.3813489418210257D-20, &
        4.4286515477520838D-20,  4.4765291580372353D-20,  4.5249968120658306D-20,  4.5740702418054417D-20, &
        4.6237659171683015D-20,  4.6741010952818368D-20,  4.7250938740823415D-20,  4.7767632507051219D-20, &
        4.8291291852069895D-20,  4.8822126702292804D-20,  4.9360358072933852D-20,  4.9906218905182021D-20, &
        5.0459954986625539D-20,  5.1021825965285324D-20,  5.1592106469178258D-20,  5.2171087345169234D-20, &
        5.2759077033045284D-20,  5.3356403093325858D-20,  5.3963413910399511D-20,  5.4580480596259246D-20, &
        5.5207999124535584D-20,  5.5846392729873830D-20,  5.6496114614193770D-20,  5.7157651009290713D-20, &
        5.7831524654956632D-20,  5.8518298763794323D-20,  5.9218581558791713D-20,  5.9933031488338700D-20, &
        6.0662363246796887D-20,  6.1407354758435000D-20,  6.2168855320499763D-20,  6.2947795150103727D-20, &
        6.3745196643214394D-20,  6.4562187737537985D-20,  6.5400017881889097D-20,  6.6260077263309343D-20, &
        6.7143920145146620D-20,  6.8053293447301698D-20,  6.8990172088133000D-20,  6.9956803158564498D-20, &
        7.0955761794878430D-20,  7.1990022788945080D-20,  7.3063053739105458D-20,  7.4178938266266893D-20, &
        7.5342542134173124D-20,  7.6559742171142969D-20,  7.7837749863412850D-20,  7.9185582674029512D-20, &
        8.0614775537353300D-20,  8.2140502769818073D-20,  8.3783445978280519D-20,  8.5573129249678161D-20, &
        8.7554459669590100D-20,  8.9802388057706877D-20,  9.2462471421151086D-20,  9.5919641344951721D-20, &
        1.0842021724855044D-19]

    ! alias_threshold[j] is a threshold for the probability mass function that has been
    ! scaled by (2**64 - 1), translated by -(2**63), and represented as a long value;
    ! in this way it can be directly compared to a randomly chosen long value.
    INTEGER(KIND=I8B), PARAMETER :: ExponentialAliasThreshold(0:255) = [ &    ! 256 entries
        9223372036854775807_I8B,  1623796909450829958_I8B,  2664290944894281002_I8B,  7387971354164055035_I8B, &
        6515064486552722205_I8B,  8840508362680707094_I8B,  6099647593382923818_I8B,  7673130333659514446_I8B, &
        6220332867583438718_I8B,  5045979640552814279_I8B,  4075305837223956071_I8B,  3258413672162525964_I8B, &
        2560664887087763045_I8B,  1957224924672900129_I8B,  1429800935350578000_I8B,   964606309710808688_I8B, &
        551043923599587587_I8B,   180827629096889062_I8B,  -152619738120023316_I8B,  -454588624410291246_I8B, &
        -729385126147774679_I8B,  -980551509819444511_I8B, -1211029700667463575_I8B, -1423284293868546830_I8B, &
        -1619396356369066372_I8B, -1801135830956194794_I8B, -1970018048575634032_I8B, -2127348289059688469_I8B, &
        -2274257249303687482_I8B, -2411729520096654942_I8B, -2540626634159182211_I8B, -2661705860113406183_I8B, &
        -2775635634532464842_I8B, -2883008316030448462_I8B, -2984350790383654449_I8B, -3080133339198118132_I8B, &
        -3170777096303105047_I8B, -3256660348483802362_I8B, -3338123885075135933_I8B, -3415475560473298752_I8B, &
        -3488994201966444258_I8B, -3558932970354456420_I8B, -3625522261068040742_I8B, -3688972217741991689_I8B, &
        -3749474917563779627_I8B, -3807206277531072172_I8B, -3862327722496826830_I8B, -3914987649156779312_I8B, &
        -3965322714631864882_I8B, -4013458973776911635_I8B, -4059512885612766613_I8B, -4103592206186240662_I8B, &
        -4145796782586127736_I8B, -4186219260694346585_I8B, -4224945717447274810_I8B, -4262056226866285147_I8B, &
        -4297625367836519229_I8B, -4331722680528536958_I8B, -4364413077437472159_I8B, -4395757214229421760_I8B, &
        -4425811824915119137_I8B, -4454630025296932322_I8B, -4482261588141294467_I8B, -4508753193105275908_I8B, &
        -4534148654077813412_I8B, -4558489126279965349_I8B, -4581813295192216486_I8B, -4604157549138252679_I8B, &
        -4625556137145250151_I8B, -4646041313519109096_I8B, -4665643470413305673_I8B, -4684391259530342697_I8B, &
        -4702311703971745066_I8B, -4719430301145102986_I8B, -4735771117539946027_I8B, -4751356876102086987_I8B, &
        -4766209036859150188_I8B, -4780347871385996716_I8B, -4793792531638885869_I8B, -4806561113635132333_I8B, &
        -4818670716409312334_I8B, -4830137496634465358_I8B, -4840976719260854030_I8B, -4851202804490332239_I8B, &
        -4860829371376476047_I8B, -4869869278311650511_I8B, -4878334660640770576_I8B, -4886236965617426832_I8B, &
        -4893586984900802224_I8B, -4900394884772702384_I8B, -4906670234238884945_I8B, -4912422031164489009_I8B, &
        -4917658726580135697_I8B, -4922388247283531793_I8B, -4926618016851042065_I8B, -4930354975163351025_I8B, &
        -4933605596540650674_I8B, -4936375906575303186_I8B, -4938671497741357106_I8B, -4940497543854583186_I8B, &
        -4941858813449628882_I8B, -4942759682136114354_I8B, -4943204143989086194_I8B, -4943195822025527282_I8B, &
        -4942737977813222130_I8B, -4941833520255011698_I8B, -4940485013586759090_I8B, -4938694684624342322_I8B, &
        -4936464429291795314_I8B, -4933795818458824946_I8B, -4930690103114057265_I8B, -4927148218896863345_I8B, &
        -4923170790008291569_I8B, -4918758132519196401_I8B, -4913910257091661489_I8B, -4908626871126522161_I8B, &
        -4902907380349538608_I8B, -4896750889844272240_I8B, -4890156204540530416_I8B, -4883121829162570096_I8B, &
        -4875645967641780528_I8B, -4867726521994909999_I8B, -4859361090668119087_I8B, -4850546966345102383_I8B, &
        -4841281133215538414_I8B, -4831560263698491374_I8B, -4821380714613452974_I8B, -4810738522790065581_I8B, &
        -4799629400105481389_I8B, -4788048727936296621_I8B, -4775991551010524588_I8B, -4763452570642113772_I8B, &
        -4750426137329493931_I8B, -4736906242696388587_I8B, -4722886510751367403_I8B, -4708360188440104938_I8B, &
        -4693320135461420394_I8B, -4677758813316098089_I8B, -4661668273553495721_I8B, -4645040145179234152_I8B, &
        -4627865621182771687_I8B, -4610135444140936871_I8B, -4591839890849352486_I8B, -4572968755929944934_I8B, &
        -4553511334358213029_I8B, -4533456402849109028_I8B, -4512792200036270244_I8B, -4491506405372580067_I8B, &
        -4469586116675401954_I8B, -4447017826233099938_I8B, -4423787395382284961_I8B, -4399880027458416864_I8B, &
        -4375280239014124063_I8B, -4349971829190464606_I8B, -4323937847117722654_I8B, -4297160557210942813_I8B, &
        -4269621402214950684_I8B, -4241300963840750107_I8B, -4212178920821854874_I8B, -4182234004204445017_I8B, &
        -4151443949668869272_I8B, -4119785446662323159_I8B, -4087234084103169942_I8B, -4053764292396165205_I8B, &
        -4019349281473092435_I8B, -3983960974549686930_I8B, -3947569937258414993_I8B, -3910145301787337104_I8B, &
        -3871654685619049615_I8B, -3832064104425389837_I8B, -3791337878631529676_I8B, -3749438533114328651_I8B, &
        -3706326689447979465_I8B, -3661960950051859912_I8B, -3616297773528542022_I8B, -3569291340409179909_I8B, &
        -3520893408440947267_I8B, -3471053156460649921_I8B, -3419717015797783872_I8B, -3366828488034801534_I8B, &
        -3312327947826461820_I8B, -3256152429334023226_I8B, -3198235394669709240_I8B, -3138506482563174262_I8B, &
        -3076891235255164340_I8B, -3013310801389715890_I8B, -2947681612411392816_I8B, -2879915029671670702_I8B, &
        -2809916959107519276_I8B, -2737587429961855017_I8B, -2662820133571332903_I8B, -2585501917733374884_I8B, &
        -2505512231579392929_I8B, -2422722515205190175_I8B, -2336995527534106140_I8B, -2248184604988712345_I8B, &
        -2156132842510782614_I8B, -2060672187261016979_I8B, -1961622433929380112_I8B, -1858790108950090508_I8B, &
        -1751967229002904073_I8B, -1640929916937134981_I8B, -1525436855617591297_I8B, -1405227557075245821_I8B, &
        -1280020420662651897_I8B, -1149510549536605301_I8B, -1013367289578706928_I8B,  -871231448632089708_I8B, &
        -722712146453677415_I8B,  -567383236774421729_I8B,  -404779231966956764_I8B,  -234390647591531478_I8B, &
        -55658667960121553_I8B,   132030985907831093_I8B,   329355128892817467_I8B,   537061298001091010_I8B, &
        755977262693561929_I8B,   987022116608030929_I8B,  1231219266829437401_I8B,  1489711711346524770_I8B, &
        1763780090187559275_I8B,  2054864117341782772_I8B,  2364588157623782527_I8B,  2694791916990482441_I8B, &
        3047567482883491349_I8B,  3425304305830820514_I8B,  3830744187097285423_I8B,  4267048975685836605_I8B, &
        4737884547990014029_I8B,  5247525842199011422_I8B,  5800989391535342064_I8B,  6404202162993303300_I8B, &
        7064218894258526746_I8B,  7789505049452354354_I8B,  8590309807749425484_I8B,  7643763810684501605_I8B, &
        8891950541491453167_I8B,  5457384281016234818_I8B,  9083704440929285914_I8B,  7976211653914461751_I8B, &
        8178631350487124609_I8B,  2821287825726757492_I8B,  6322989683301736617_I8B,  4309503753387630347_I8B, &
        4685170734960191673_I8B,  8404845967535252693_I8B,  7330522972447610419_I8B,  1960945799077061994_I8B, &
        4742910674644933674_I8B,  -751799822533438695_I8B,  7023456603742021660_I8B,  3843116882594755262_I8B, &
        3927231442413889375_I8B, -9223372036854775807_I8B, -9223372036854775807_I8B, -9223372036854775807]

    INTEGER(KIND=I1B), PARAMETER :: ExponentialAliasMap(0:255) = [ &    ! 256 entries
        INT(0, KIND=I1B), INT(0, KIND=I1B), INT(1, KIND=I1B), INT(235, KIND=I1B), INT(3, KIND=I1B), INT(4, KIND=I1B), INT(5, KIND=I1B), INT(0, KIND=I1B), &
        INT(0, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), &
        INT(0, KIND=I1B), INT(0, KIND=I1B), INT(1, KIND=I1B), INT(1, KIND=I1B), INT(1, KIND=I1B), INT(1, KIND=I1B), INT(2, KIND=I1B), INT(2, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
        INT(252, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), &
        INT(251, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), INT(250, KIND=I1B), INT(250, KIND=I1B), &
        INT(250, KIND=I1B), INT(250, KIND=I1B), INT(250, KIND=I1B), INT(250, KIND=I1B), INT(250, KIND=I1B), INT(249, KIND=I1B), INT(249, KIND=I1B), INT(249, KIND=I1B), &
        INT(249, KIND=I1B), INT(249, KIND=I1B), INT(249, KIND=I1B), INT(248, KIND=I1B), INT(248, KIND=I1B), INT(248, KIND=I1B), INT(248, KIND=I1B), INT(247, KIND=I1B), &
        INT(247, KIND=I1B), INT(247, KIND=I1B), INT(247, KIND=I1B), INT(246, KIND=I1B), INT(246, KIND=I1B), INT(246, KIND=I1B), INT(245, KIND=I1B), INT(245, KIND=I1B), &
        INT(244, KIND=I1B), INT(244, KIND=I1B), INT(243, KIND=I1B), INT(243, KIND=I1B), INT(242, KIND=I1B), INT(241, KIND=I1B), INT(241, KIND=I1B), INT(240, KIND=I1B), &
        INT(239, KIND=I1B), INT(237, KIND=I1B), INT(3, KIND=I1B), INT(3, KIND=I1B), INT(4, KIND=I1B), INT(4, KIND=I1B), INT(6, KIND=I1B), INT(0, KIND=I1B), &
        INT(0, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), INT(236, KIND=I1B), INT(237, KIND=I1B), INT(238, KIND=I1B), INT(239, KIND=I1B), INT(240, KIND=I1B), &
        INT(241, KIND=I1B), INT(242, KIND=I1B), INT(243, KIND=I1B), INT(244, KIND=I1B), INT(245, KIND=I1B), INT(246, KIND=I1B), INT(247, KIND=I1B), INT(248, KIND=I1B), &
        INT(249, KIND=I1B), INT(250, KIND=I1B), INT(251, KIND=I1B), INT(252, KIND=I1B), INT(2, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B)]

    ! Implementation support for modified-ziggurat implementation of nextGaussian()

    ! Fraction of the area under the curve that lies outside the layer boxes: 0.0117
    ! Fraction of non-box area that lies in the tail of the distribution: 0.0236

    INTEGER(KIND=I4B), PARAMETER :: NormalNumberOfLayers = 253
    INTEGER(KIND=I4B), PARAMETER :: NormalLayerMask = INT(Z'000000FF', KIND=I4B)
    INTEGER(KIND=I4B), PARAMETER :: NormalAliasMask = INT(Z'000000FF', KIND=I4B)
    INTEGER(KIND=I4B), PARAMETER :: NormalSignCorrectionMask = INT(Z'000000FF', KIND=I4B)
    REAL(KIND=DP),     PARAMETER :: NormalX0 = 3.63600662550094578_DP
    INTEGER(KIND=I4B), PARAMETER :: NormalInflectionIndex = 204
    INTEGER(KIND=I8B), PARAMETER :: NormalConvexMargin = 760463704284035183_I8B    ! unscaled convex margin = 0.0824
    INTEGER(KIND=I8B), PARAMETER :: NormalConcaveMargin = 2269182951627976012_I8B  ! unscaled concave margin = 0.2460

    ! Normal_NormalX(i] = length of ziggurat layer i for Normal distribution, scaled by 2**(-63)
    REAL(KIND=DP),     PARAMETER :: NormalX(0:253) = [ &      ! 254 entries, which is Normal_number_of_layers+1
            3.9421662825398133D-19,  3.7204945004119012D-19,  3.5827024480628678D-19,  3.4807476236540249D-19, &
            3.3990177171882136D-19,  3.3303778360340139D-19,  3.2709438817617550D-19,  3.2183577132495100D-19, &
            3.1710758541840432D-19,  3.1280307407034065D-19,  3.0884520655804019D-19,  3.0517650624107352D-19, &
            3.0175290292584600D-19,  2.9853983440705320D-19,  2.9550967462801797D-19,  2.9263997988491663D-19, &
            2.8991225869977476D-19,  2.8731108780226291D-19,  2.8482346327101335D-19,  2.8243831535194389D-19, &
            2.8014613964727031D-19,  2.7793871261807797D-19,  2.7580886921411212D-19,  2.7375032698308758D-19, &
            2.7175754543391047D-19,  2.6982561247538484D-19,  2.6795015188771505D-19,  2.6612724730440033D-19, &
            2.6435337927976633D-19,  2.6262537282028438D-19,  2.6094035335224142D-19,  2.5929570954331002D-19, &
            2.5768906173214726D-19,  2.5611823497719608D-19,  2.5458123593393361D-19,  2.5307623292372459D-19, &
            2.5160153867798400D-19,  2.5015559533646191D-19,  2.4873696135403158D-19,  2.4734430003079206D-19, &
            2.4597636942892726D-19,  2.4463201347912450D-19,  2.4331015411139206D-19,  2.4200978427132955D-19, &
            2.4072996170445879D-19,  2.3946980340903347D-19,  2.3822848067252674D-19,  2.3700521461931801D-19, &
            2.3579927220741330D-19,  2.3460996262069972D-19,  2.3343663401054455D-19,  2.3227867054673840D-19, &
            2.3113548974303765D-19,  2.3000654002704238D-19,  2.2889129852797606D-19,  2.2778926905921897D-19, &
            2.2669998027527321D-19,  2.2562298398527416D-19,  2.2455785360727260D-19,  2.2350418274933911D-19, &
            2.2246158390513294D-19,  2.2142968725296249D-19,  2.2040813954857555D-19,  2.1939660310297601D-19, &
            2.1839475483749618D-19,  2.1740228540916853D-19,  2.1641889840016519D-19,  2.1544430956570613D-19, &
            2.1447824613540345D-19,  2.1352044616350571D-19,  2.1257065792395107D-19,  2.1162863934653125D-19, &
            2.1069415749082026D-19,  2.0976698805483467D-19,  2.0884691491567363D-19,  2.0793372969963634D-19, &
            2.0702723137954107D-19,  2.0612722589717129D-19,  2.0523352580895635D-19,  2.0434594995315797D-19, &
            2.0346432313698148D-19,  2.0258847584216418D-19,  2.0171824394771313D-19,  2.0085346846857531D-19, &
            1.9999399530912015D-19,  1.9913967503040585D-19,  1.9829036263028144D-19,  1.9744591733545175D-19, &
            1.9660620240469857D-19,  1.9577108494251485D-19,  1.9494043572246307D-19,  1.9411412901962161D-19, &
            1.9329204245152935D-19,  1.9247405682708168D-19,  1.9166005600287074D-19,  1.9084992674649826D-19, &
            1.9004355860642340D-19,  1.8924084378793725D-19,  1.8844167703488436D-19,  1.8764595551677749D-19, &
            1.8685357872097450D-19,  1.8606444834960934D-19,  1.8527846822098793D-19,  1.8449554417517928D-19, &
            1.8371558398354868D-19,  1.8293849726199566D-19,  1.8216419538767393D-19,  1.8139259141898448D-19, &
            1.8062360001864453D-19,  1.7985713737964743D-19,  1.7909312115393845D-19,  1.7833147038364200D-19, &
            1.7757210543468428D-19,  1.7681494793266395D-19,  1.7605992070083140D-19,  1.7530694770004409D-19, &
            1.7455595397057217D-19,  1.7380686557563475D-19,  1.7305960954655264D-19,  1.7231411382940904D-19, &
            1.7157030723311378D-19,  1.7082811937877138D-19,  1.7008748065025788D-19,  1.6934832214591352D-19, &
            1.6861057563126349D-19,  1.6787417349268046D-19,  1.6713904869190636D-19,  1.6640513472135291D-19, &
            1.6567236556010242D-19,  1.6494067563053266D-19,  1.6420999975549115D-19,  1.6348027311594532D-19, &
            1.6275143120903661D-19,  1.6202340980646725D-19,  1.6129614491314931D-19,  1.6056957272604589D-19, &
            1.5984362959313479D-19,  1.5911825197242491D-19,  1.5839337639095554D-19,  1.5766893940370800D-19, &
            1.5694487755235889D-19,  1.5622112732380261D-19,  1.5549762510837070D-19,  1.5477430715767271D-19, &
            1.5405110954198330D-19,  1.5332796810709688D-19,  1.5260481843056974D-19,  1.5188159577726683D-19, &
            1.5115823505412761D-19,  1.5043467076406199D-19,  1.4971083695888395D-19,  1.4898666719118714D-19, &
            1.4826209446506113D-19,  1.4753705118554365D-19,  1.4681146910669830D-19,  1.4608527927820112D-19, &
            1.4535841199031451D-19,  1.4463079671711862D-19,  1.4390236205786415D-19,  1.4317303567630177D-19, &
            1.4244274423783481D-19,  1.4171141334433217D-19,  1.4097896746642792D-19,  1.4024532987312287D-19, &
            1.3951042255849034D-19,  1.3877416616527576D-19,  1.3803647990516385D-19,  1.3729728147547174D-19, &
            1.3655648697200824D-19,  1.3581401079782068D-19,  1.3506976556752901D-19,  1.3432366200692418D-19, &
            1.3357560884748263D-19,  1.3282551271542047D-19,  1.3207327801488087D-19,  1.3131880680481524D-19, &
            1.3056199866908076D-19,  1.2980275057923788D-19,  1.2904095674948608D-19,  1.2827650848312727D-19, &
            1.2750929400989213D-19,  1.2673919831340482D-19,  1.2596610294799512D-19,  1.2518988584399374D-19, &
            1.2441042110056523D-19,  1.2362757876504165D-19,  1.2284122459762072D-19,  1.2205121982017852D-19, &
            1.2125742084782245D-19,  1.2045967900166973D-19,  1.1965784020118020D-19,  1.1885174463419555D-19, &
            1.1804122640264091D-19,  1.1722611314162064D-19,  1.1640622560939109D-19,  1.1558137724540874D-19, &
            1.1475137369333185D-19,  1.1391601228549047D-19,  1.1307508148492592D-19,  1.1222836028063025D-19, &
            1.1137561753107903D-19,  1.1051661125053526D-19,  1.0965108783189755D-19,  1.0877878119905372D-19, &
            1.0789941188076655D-19,  1.0701268599703640D-19,  1.0611829414763286D-19,  1.0521591019102928D-19, &
            1.0430518990027552D-19,  1.0338576948035472D-19,  1.0245726392923699D-19,  1.0151926522209310D-19, &
            1.0057134029488235D-19,  9.9613028799672809D-20,  9.8643840599459914D-20,  9.7663252964755816D-20, &
            9.6670707427623454D-20,  9.5665606240866670D-20,  9.4647308380433213D-20,  9.3615125017323508D-20, &
            9.2568314370887282D-20,  9.1506075837638774D-20,  9.0427543267725716D-20,  8.9331777233763680D-20, &
            8.8217756102327883D-20,  8.7084365674892319D-20,  8.5930387109612162D-20,  8.4754482764244349D-20, &
            8.3555179508462343D-20,  8.2330848933585364D-20,  8.1079683729129853D-20,  7.9799669284133864D-20, &
            7.8488549286072745D-20,  7.7143783700934692D-20,  7.5762496979467566D-20,  7.4341413578485329D-20, &
            7.2876776807378431D-20,  7.1364245443525374D-20,  6.9798760240761066D-20,  6.8174368944799054D-20, &
            6.6483992986198539D-20,  6.4719110345162767D-20,  6.2869314813103699D-20,  6.0921687548281263D-20, &
            5.8859873575576818D-20,  5.6662675116090981D-20,  5.4301813630894571D-20,  5.1738171744494220D-20, &
            4.8915031722398545D-20,  4.5744741890755301D-20,  4.2078802568583416D-20,  3.7625986722404761D-20, &
            3.1628589805881879D-20,  0.0000000000000000D+00]

    ! Normal_NormalY(i] = value of the Normal distribution function at Normal_NormalX(i], scaled by 2**(-63)
    REAL(KIND=DP),     PARAMETER :: NormalY(0:253) = [ &      ! 254 entries, which is Normal_number_of_layers+1
            1.4598410796619063D-22,  3.0066613427942797D-22,  4.6129728815103466D-22,  6.2663350049234362D-22, &
            7.9594524761881544D-22,  9.6874655021705039D-22,  1.1446877002379439D-21,  1.3235036304379167D-21, &
            1.5049857692053131D-21,  1.6889653000719298D-21,  1.8753025382711626D-21,  2.0638798423695191D-21, &
            2.2545966913644708D-21,  2.4473661518801799D-21,  2.6421122727763533D-21,  2.8387681187879908D-21, &
            3.0372742567457284D-21,  3.2375775699986589D-21,  3.4396303157948780D-21,  3.6433893657997798D-21, &
            3.8488155868912312D-21,  4.0558733309492775D-21,  4.2645300104283590D-21,  4.4747557422305067D-21, &
            4.6865230465355582D-21,  4.8998065902775257D-21,  5.1145829672105489D-21,  5.3308305082046173D-21, &
            5.5485291167031758D-21,  5.7676601252690476D-21,  5.9882061699178461D-21,  6.2101510795442221D-21, &
            6.4334797782257209D-21,  6.6581781985713897D-21,  6.8842332045893181D-21,  7.1116325227957095D-21, &
            7.3403646804903092D-21,  7.5704189502886418D-21,  7.8017853001379744D-21,  8.0344543481570017D-21, &
            8.2684173217333118D-21,  8.5036660203915022D-21,  8.7401927820109521D-21,  8.9779904520281901D-21, &
            9.2170523553061439D-21,  9.4573722703928820D-21,  9.6989444059269430D-21,  9.9417633789758424D-21, &
            1.0185824195119818D-20,  1.0431122230114770D-20,  1.0677653212987396D-20,  1.0925413210432004D-20, &
            1.1174398612392891D-20,  1.1424606118728715D-20,  1.1676032726866302D-20,  1.1928675720361027D-20, &
            1.2182532658289373D-20,  1.2437601365406785D-20,  1.2693879923010674D-20,  1.2951366660454145D-20, &
            1.3210060147261461D-20,  1.3469959185800733D-20,  1.3731062804473644D-20,  1.3993370251385596D-20, &
            1.4256880988463136D-20,  1.4521594685988369D-20,  1.4787511217522902D-20,  1.5054630655196170D-20, &
            1.5322953265335218D-20,  1.5592479504415048D-20,  1.5863210015310328D-20,  1.6135145623830982D-20, &
            1.6408287335525592D-20,  1.6682636332737932D-20,  1.6958193971903124D-20,  1.7234961781071113D-20, &
            1.7512941457646084D-20,  1.7792134866331487D-20,  1.8072544037271070D-20,  1.8354171164377277D-20, &
            1.8637018603838945D-20,  1.8921088872801004D-20,  1.9206384648209468D-20,  1.9492908765815636D-20, &
            1.9780664219333857D-20,  2.0069654159747839D-20,  2.0359881894760859D-20,  2.0651350888385696D-20, &
            2.0944064760670539D-20,  2.1238027287557466D-20,  2.1533242400870487D-20,  2.1829714188430474D-20, &
            2.2127446894294597D-20,  2.2426444919118270D-20,  2.2726712820637798D-20,  2.3028255314272276D-20, &
            2.3331077273843558D-20,  2.3635183732413286D-20,  2.3940579883236352D-20,  2.4247271080830277D-20, &
            2.4555262842160330D-20,  2.4864560847940368D-20,  2.5175170944049622D-20,  2.5487099143065929D-20, &
            2.5800351625915997D-20,  2.6114934743643687D-20,  2.6430855019297323D-20,  2.6748119149937411D-20, &
            2.7066734008766247D-20,  2.7386706647381193D-20,  2.7708044298153558D-20,  2.8030754376735269D-20, &
            2.8354844484695747D-20,  2.8680322412291631D-20,  2.9007196141372126D-20,  2.9335473848423219D-20, &
            2.9665163907753988D-20,  2.9996274894828624D-20,  3.0328815589748056D-20,  3.0662794980885287D-20, &
            3.0998222268678760D-20,  3.1335106869588609D-20,  3.1673458420220558D-20,  3.2013286781622988D-20, &
            3.2354602043762612D-20,  3.2697414530184806D-20,  3.3041734802864950D-20,  3.3387573667257349D-20, &
            3.3734942177548938D-20,  3.4083851642125208D-20,  3.4434313629256243D-20,  3.4786339973011376D-20, &
            3.5139942779411164D-20,  3.5495134432826171D-20,  3.5851927602632460D-20,  3.6210335250134172D-20, &
            3.6570370635764384D-20,  3.6932047326575882D-20,  3.7295379204034252D-20,  3.7660380472126401D-20, &
            3.8027065665798284D-20,  3.8395449659736649D-20,  3.8765547677510167D-20,  3.9137375301086406D-20, &
            3.9510948480742172D-20,  3.9886283545385430D-20,  4.0263397213308566D-20,  4.0642306603393541D-20, &
            4.1023029246790967D-20,  4.1405583099096438D-20,  4.1789986553048817D-20,  4.2176258451776819D-20, &
            4.2564418102621759D-20,  4.2954485291566197D-20,  4.3346480298300118D-20,  4.3740423911958146D-20, &
            4.4136337447563716D-20,  4.4534242763218286D-20,  4.4934162278076256D-20,  4.5336118991149025D-20, &
            4.5740136500984466D-20,  4.6146239026271279D-20,  4.6554451427421133D-20,  4.6964799229185088D-20, &
            4.7377308644364938D-20,  4.7792006598684169D-20,  4.8208920756888113D-20,  4.8628079550147814D-20, &
            4.9049512204847653D-20,  4.9473248772842596D-20,  4.9899320163277674D-20,  5.0327758176068971D-20, &
            5.0758595537153414D-20,  5.1191865935622696D-20,  5.1627604062866059D-20,  5.2065845653856416D-20, &
            5.2506627530725194D-20,  5.2949987648783448D-20,  5.3395965145159426D-20,  5.3844600390237576D-20, &
            5.4295935042099358D-20,  5.4750012104183868D-20,  5.5206875986405073D-20,  5.5666572569983821D-20, &
            5.6129149276275792D-20,  5.6594655139902476D-20,  5.7063140886520563D-20,  5.7534659015596918D-20, &
            5.8009263888591218D-20,  5.8487011822987583D-20,  5.8967961192659803D-20,  5.9452172535103471D-20, &
            5.9939708666122605D-20,  6.0430634802618929D-20,  6.0925018694200531D-20,  6.1422930764402860D-20, & 
            6.1924444262401531D-20,  6.2429635426193939D-20,  6.2938583658336214D-20,  6.3451371715447563D-20, &
            6.3968085912834963D-20,  6.4488816345752736D-20,  6.5013657128995346D-20,  6.5542706656731714D-20, &
            6.6076067884730717D-20,  6.6613848637404196D-20,  6.7156161942412980D-20,  6.7703126395950580D-20, &
            6.8254866562246408D-20,  6.8811513411327825D-20,  6.9373204799659681D-20,  6.9940085998959109D-20, &
            7.0512310279279503D-20,  7.1090039553397167D-20,  7.1673445090644796D-20,  7.2262708309655784D-20, &
            7.2858021661057338D-20,  7.3459589613035800D-20,  7.4067629754967553D-20,  7.4682374037052817D-20, &
            7.5304070167226666D-20,  7.5932983190698547D-20,  7.6569397282483754D-20,  7.7213617789487678D-20, &
            7.7865973566417016D-20,  7.8526819659456755D-20,  7.9196540403850560D-20,  7.9875553017037968D-20, &
            8.0564311788901630D-20,  8.1263312996426176D-20,  8.1973100703706304D-20,  8.2694273652634034D-20, &
            8.3427493508836792D-20,  8.4173494807453416D-20,  8.4933097052832066D-20,  8.5707219578230905D-20, &
            8.6496899985930695D-20,  8.7303317295655327D-20,  8.8127821378859504D-20,  8.8971970928196666D-20, &
            8.9837583239314064D-20,  9.0726800697869543D-20,  9.1642181484063544D-20,  9.2586826406702765D-20, &
            9.3564561480278864D-20,  9.4580210012636175D-20,  9.5640015550850358D-20,  9.6752334770503130D-20, &
            9.7928851697808831D-20,  9.9186905857531331D-20,  1.0055456271343397D-19,  1.0208407377305566D-19, &
            1.0390360993240711D-19,  1.0842021724855044D-19]

    ! alias_threshold[j] is a threshold for the probability mass function that has been
    ! scaled by (2**64 - 1), translated by -(2**63), and represented as a long value;
    ! in this way it can be directly compared to a randomly chosen long value.
    INTEGER(KIND=I8B), PARAMETER :: NormalAliasThreshold(0:255) = [ &    ! 256 entries
            9223372036854775732_I8B,  1100243796470199922_I8B,  7866600928967318259_I8B,  6788754710669718688_I8B, &
            9022865200207136940_I8B,  6522434035182564354_I8B,  4723064097388367094_I8B,  3360495653202227820_I8B, &
            2289663232347306830_I8B,  1423968905585875379_I8B,   708364817795238883_I8B,   106102487338962592_I8B, &
            -408333464668584328_I8B,  -853239722790494085_I8B, -1242095211827090004_I8B, -1585059631108655444_I8B, &
            -1889943050267333598_I8B, -2162852901996526266_I8B, -2408637386596951353_I8B, -2631196530256993348_I8B, &
            -2833704942542501760_I8B, -3018774289008775598_I8B, -3188573753501888049_I8B, -3344920681670389334_I8B, &
            -3489349705095933019_I8B, -3623166100045386711_I8B, -3747487436861293578_I8B, -3863276422709141026_I8B, &
            -3971367044055496571_I8B, -4072485557008423504_I8B, -4167267476835653997_I8B, -4256271432259158584_I8B, &
            -4339990541931699221_I8B, -4418861817116128356_I8B, -4493273980399812066_I8B, -4563574004455583972_I8B, &
            -4630072609765608272_I8B, -4693048910437239656_I8B, -4752754358851355990_I8B, -4809416110064308151_I8B, &
            -4863239903553549801_I8B, -4914412541525462120_I8B, -4963104028438393907_I8B, -5009469424783376781_I8B, &
            -5053650458852410933_I8B, -5095776932714599237_I8B, -5135967952538787362_I8B, -5174333008440005397_I8B, &
            -5210972924976812191_I8B, -5245980700089102084_I8B, -5279442247516610920_I8B, -5311437055455710870_I8B, &
            -5342038772315685218_I8B, -5371315728848281940_I8B, -5399331404596850615_I8B, -5426144845492958401_I8B, &
            -5451811038482575296_I8B, -5476381248268660540_I8B, -5499903320574200237_I8B, -5522421955754019296_I8B, &
            -5543978956088644891_I8B, -5564613449670076120_I8B, -5584362093426489951_I8B, -5603259257517942559_I8B, &
            -5621337193067953247_I8B, -5638626184957155131_I8B, -5655154691206501482_I8B, -5670949470299055313_I8B, &
            -5686035697633988263_I8B, -5700437072176015065_I8B, -5714175914241450413_I8B, -5727273255262198220_I8B, &
            -5739748920276454057_I8B, -5751621603817308582_I8B, -5762908939796390234_I8B, -5773627565922293024_I8B, &
            -5783793183134813122_I8B, -5793420610488485693_I8B, -5802523835876777512_I8B, -5811116062947540603_I8B, &
            -5819209754528321254_I8B, -5826816672847738703_I8B, -5833947916812588598_I8B, -5840613956576464230_I8B, &
            -5846824665611918318_I8B, -5852589350480860931_I8B, -5857916778478181241_I8B, -5862815203308620040_I8B, &
            -5867292388942958035_I8B, -5871355631785040459_I8B, -5875011781271709877_I8B, -5878267259014830525_I8B, &
            -5881128076587168793_I8B, -5883599852042383670_I8B, -5885687825255517495_I8B, -5887396872158140520_I8B, &
            -5888731517940791413_I8B, -5889695949285098191_I8B, -5890294025685452079_I8B, -5890529289913339019_I8B, &
            -5890404977673728891_I8B, -5889924026498433105_I8B, -5889089083917111413_I8B, -5887902514943630556_I8B, &
            -5886366408911444323_I8B, -5884482585689698188_I8B, -5882252601307215732_I8B, -5879677753010810505_I8B, &
            -5876759083779777633_I8B, -5873497386319005871_I8B, -5869893206546653493_I8B, -5865946846595933526_I8B, &
            -5861658367342436656_I8B, -5857027590471882377_I8B, -5852054100098427498_I8B, -5846737243942430862_I8B, &
            -5841076134076202917_I8B, -5835069647242632620_I8B, -5828716424752710909_I8B, -5822014871963881822_I8B, &
            -5814963157341321336_I8B, -5807559211102860368_I8B, -5799800723445392235_I8B, -5791685142351319976_I8B, &
            -5783209670970726741_I8B, -5774371264573181466_I8B, -5765166627063894671_I8B, -5755592207054728713_I8B, &
            -5745644193480823967_I8B, -5735318510752045177_I8B, -5724610813425415465_I8B, -5713516480385581414_I8B, &
            -5702030608515423737_I8B, -5690148005840583288_I8B, -5677863184127162093_I8B, -5665170350911168791_I8B, &
            -5652063400935782694_I8B, -5638535906971010691_I8B, -5624581109986711207_I8B, -5610191908648783765_I8B, &
            -5595360848105231304_I8B, -5580080108024969737_I8B, -5564341489852042876_I8B, -5548136403231016978_I8B, &
            -5531455851558564459_I8B, -5514290416611714856_I8B, -5496630242199355791_I8B, -5478465016777918644_I8B, &
            -5459783954970839371_I8B, -5440575777921757436_I8B, -5420828692410297267_I8B, -5400530368650229789_I8B, &
            -5379667916685479525_I8B, -5358227861290596404_I8B, -5336196115276119372_I8B, -5313557951090901350_I8B, &
            -5290297970603367798_I8B, -5266400072934326313_I8B, -5241847420204395031_I8B, -5216622401044877639_I8B, &
            -5190706591710560934_I8B, -5164080714616987256_I8B, -5136724594109421094_I8B, -5108617109256031912_I8B, &
            -5079736143434386281_I8B, -5050058530465123570_I8B, -5019559997019987907_I8B, -4988215101007960589_I8B, &
            -4955997165616088151_I8B, -4922878208649305943_I8B, -4888828866781574127_I8B, -4853818314291958392_I8B, &
            -4817814175818125756_I8B, -4780782432613346925_I8B, -4742687321741700014_I8B, -4703491227589533028_I8B, &
            -4663154565006030194_I8B, -4621635653315226847_I8B, -4578890580363657638_I8B, -4534873055674290590_I8B, &
            -4489534251682380820_I8B, -4442822631912146606_I8B, -4394683764829968681_I8B, -4345060121963632469_I8B, &
            -4293890858720706245_I8B, -4241111576152819891_I8B, -4186654061709945180_I8B, -4130446006793453666_I8B, &
            -4072410698652140640_I8B, -4012466683862855933_I8B, -3950527400292573339_I8B, -3886500774045756804_I8B, &
            -3820288777448438119_I8B, -3751786943603804843_I8B, -3680883832458819395_I8B, -3607460442634330728_I8B, &
            -3531389562479403081_I8B, -3452535052892669800_I8B, -3370751053387208615_I8B, -3285881101636362572_I8B, &
            -3197757155290696249_I8B, -3106198503163967069_I8B, -3011010550898974052_I8B, -2911983463889090176_I8B, &
            -2808890647471134035_I8B, -2701487041141521265_I8B, -2589507199668960785_I8B, -2472663129352313038_I8B, &
            -2350641842148622058_I8B, -2223102583752258356_I8B, -2089673683718520949_I8B, -1949948966041670625_I8B, &
            -1803483646850545328_I8B, -1649789631543398131_I8B, -1488330106106063370_I8B, -1318513295716695859_I8B, &
            -1139685236949889721_I8B,  -951121376566993538_I8B,  -752016768187462359_I8B,  -541474585679321485_I8B, &
            -318492605702529265_I8B,   -81947227237782935_I8B,   169425512586600501_I8B,   437052607251310002_I8B, &
            722551297576808029_I8B,  1027761939321803391_I8B,  1354787941562529921_I8B,  1706044619231670700_I8B, &
            2084319374410687061_I8B,  2492846399585974279_I8B,  2935400169364870493_I8B,  3416413484632185639_I8B, &
            3941127949845221101_I8B,  4515787798750242711_I8B,  5147892401460631081_I8B,  5846529325404347588_I8B, &
            6622819682189677227_I8B,  7490522659877439279_I8B,  8466869998300400224_I8B,  8216968526327386835_I8B, &
            4550693915429835301_I8B,  7628019504075715697_I8B,  6605080500885794707_I8B,  7121156327618549405_I8B, &
            2484871780310660533_I8B,  7179104797025802172_I8B,  7066086283790288107_I8B,  1516500120772178463_I8B, &
            216305945406470492_I8B,  6295963418490399062_I8B,  2889316805640753770_I8B, -2712587580563247199_I8B, &
            6562498853480442900_I8B,  7975754821117214681_I8B, -9223372036854775807_I8B, -9223372036854775807_I8B]

    INTEGER(KIND=I8B), PARAMETER :: NormalAliasMap(0:255) = [ &    ! 256 entries
            INT(0, KIND=I1B), INT(0, KIND=I1B), INT(239, KIND=I1B), INT(2, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), &
            INT(0, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), INT(1, KIND=I1B), INT(1, KIND=I1B), INT(1, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), INT(253, KIND=I1B), &
            INT(253, KIND=I1B), INT(253, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), &
            INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(252, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), &
            INT(251, KIND=I1B), INT(251, KIND=I1B), INT(251, KIND=I1B), INT(250, KIND=I1B), INT(250, KIND=I1B), INT(250, KIND=I1B), INT(250, KIND=I1B), INT(250, KIND=I1B), &
            INT(249, KIND=I1B), INT(249, KIND=I1B), INT(249, KIND=I1B), INT(248, KIND=I1B), INT(248, KIND=I1B), INT(248, KIND=I1B), INT(247, KIND=I1B), INT(247, KIND=I1B), &
            INT(247, KIND=I1B), INT(246, KIND=I1B), INT(246, KIND=I1B), INT(245, KIND=I1B), INT(244, KIND=I1B), INT(244, KIND=I1B), INT(243, KIND=I1B), INT(242, KIND=I1B), &
            INT(240, KIND=I1B), INT(2, KIND=I1B), INT(2, KIND=I1B), INT(3, KIND=I1B), INT(3, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B), INT(240, KIND=I1B), &
            INT(241, KIND=I1B), INT(242, KIND=I1B), INT(243, KIND=I1B), INT(244, KIND=I1B), INT(245, KIND=I1B), INT(246, KIND=I1B), INT(247, KIND=I1B), INT(248, KIND=I1B), &
            INT(249, KIND=I1B), INT(250, KIND=I1B), INT(251, KIND=I1B), INT(252, KIND=I1B), INT(253, KIND=I1B), INT(1, KIND=I1B), INT(0, KIND=I1B), INT(0, KIND=I1B)]

!** DERIVED TYPE DEFINITIONS
    ! na

!** INTERFACE DEFINITIONS:
    ! na
    
!** MODULE VARIABLE DECLARATIONS:
    ! na

    CONTAINS

!** MODULE ELEMENTS SUBROUTINES or FUNCTIONS:

MODULE FUNCTION Default_NextGaussian(RNG) RESULT(RandNum)

!** PURPOSE OF THIS SUBROUTINE:
    ! To return  a 64-bit floating point value pseudorandomly chosen from a Gaussian
    ! (normal) distribution whose mean is 0 and whose standard deviation is 1.
    ! The default implementation uses McFarland's fast modified ziggurat
    ! algorithm (largely table-driven, with rare cases handled by computation
    ! and rejection sampling). Walker's alias method for sampling a discrete
    ! distribution also plays a role.

    IMPLICIT NONE
        
!** SUBROUTINE ARGUMENT DECLARATIONS:
    CLASS(BaseRNG), INTENT(INOUT)   :: RNG      ! 'BaseRNG' object
    REAL(KIND=DP)                   :: RandNum  ! random number

!** SUBROUTINE INTERNAL VARIABLE DECLARATIONS:
    INTEGER(KIND=I8B)   :: U1, U2, UA, UDiff, I
    INTEGER(KIND=I4B)   :: J
    REAL(KIND=DP)       :: SignBit, X, Y

! FLOW
    
    U1 = RNG%NextLong()
    ! Experimentation on a variety of machines indicates that it is overall much faster
    ! to do the following & and < operations on longs rather than first cast U1 to int
    ! (but then we need to cast to int before doing the array indexing operation).
    I = IAND(U1, NormalLayerMask)

    IF (I < NormalNumberOfLayers) THEN
        ! This is the fast path (occurring more than 98% of the time).  Make an early exit.
        ! Note that the sign bit of U1 is used here.
        RandNum = NormalX(I) * U1
        RETURN
    END IF
    ! We didn't use the upper part of U1 after all.
    ! Pull U1 apart into a sign bit and a 63-bit value for later use.
    IF (U1 >= 0_I8B) THEN
        SignBit = 1.0_DP
    ELSE
        SignBit = -1.0_DP
    END IF
    U1 = SHIFTR(SHIFTL(U1, 1), 1)

    ! Use Walker's alias method to sample an (unsigned) integer j from a discrete
    ! probability distribution that includes the tail and all the ziggurat overhangs
    ! j will be less than NormalNumberOfLayers + 1.
    UA = RNG%NextLong()
    J = IAND(INT(UA, KIND=I4B), NormalAliasMask)
    IF (UA >= NormalAliasThreshold(J)) THEN
        J = IAND(NormalAliasMap(J), NormalSignCorrectionMask)
    END IF

    ! Now the goal is to choose the result, which will be multiplied by SignBit just before RETURN.

    ! There are four kinds of overhangs:
    !
    !  j == 0                          :  Sample from tail
    !  0 < j < normalInflectionIndex   :  Overhang is convex can reject upper-right triangle
    !  j == normalInflectionIndex      :  Overhang includes the inflection point
    !  j > normalInflectionIndex       :  Overhang is concave can accept point in lower-left triangle
    !
    ! Choose one of four loops to compute x, each specialized for a specific kind of overhang.
    ! Conditional statements are arranged such that the more likely outcomes are first.

    ! In the three cases other than the tail case:
    ! U1 represents a fraction (scaled by 2**63) of the width of rectangle measured from the left.
    ! U2 represents a fraction (scaled by 2**63) of the height of rectangle measured from the top.
    ! Together they indicate a randomly chosen point within the rectangle.

    IF (J > NormalInflectionIndex) THEN   ! Concave overhang
        DO
            U2 = SHIFTR(RNG%NextLong(), 1)
            ! Compute the actual x-coordinate of the randomly chosen point.
            X = (NormalX(J) * Multiplier) + ((NormalX(J-1) - NormalX(J)) * INT(U1, KIND=DP))
            ! Does the point lie below the curve?
            UDiff = U2 - U1
            IF (UDiff >= 0) THEN
                EXIT   ! The chosen point is in the lower-left triangle accept it.
            END IF
            IF (UDiff <= -NormalConcaveMargin) THEN
                CYCLE   ! The chosen point is way above the curve reject it.
            END IF
            ! Compute the actual y-coordinate of the randomly chosen point.
            Y = (NormalY(J) * Multiplier) + ((NormalY(J-1) - NormalY(J)) * INT(U2, KIND=DP))
            ! Now see how that y-coordinate compares to the curve
            IF (Y <= EXP(-0.5_DP*X*X)) THEN
                EXIT   ! The chosen point is below the curve accept it.
            END IF
            ! Otherwise, we reject this sample and have to try again.
            U1 = SHIFTR(RNG%NextLong(), 1)
        END DO
    ELSEIF (J == 0) THEN   ! Tail
        ! Tail-sampling method of Marsaglia and Tsang.  See any one of:
        ! Marsaglia and Tsang. 1984. A fast, easily implemented method for sampling from decreasing
        !    or symmetric unimodal density functions. SIAM J. Sci. Stat. Comput. 5, 349-359.
        ! Marsaglia and Tsang. 1998. The Monty Python method for generating random variables.
        !    ACM Trans. Math. Softw. 24, 3 (September 1998), 341-350.  See page 342, step (4).
        !    http:!doi.org/10.1145/292395.292453
        ! Thomas, Luk, Leong, and Villasenor. 2007. Gaussian random number generators.
        !    ACM Comput. Surv. 39, 4, Article 11 (November 2007).  See Algorithm 16.
        !    http:!doi.org/10.1145/1287620.1287622
        ! Compute two separate random exponential samples and then compare them in certain way.
        DO
            X = (1.0_DP / NormalX0) * RNG%NextExponential()
            IF (RNG%NextExponential() >= 0.5_DP*X*X) EXIT
        END DO
        X = X + NormalX0
    ELSEIF (J < NormalInflectionIndex) THEN   ! Convex overhang
        DO
            U2 = SHIFTR(RNG%NextLong(), 1)
            ! Does the point lie below the curve?
            UDiff = U2 - U1
            IF (UDiff < 0) THEN
                ! We picked a point in the upper-right triangle.  None of those can be accepted.
                ! So remap the point into the lower-left triangle and try that.
                ! In effect, we swap U1 and U2, and invert the sign of UDiff.
                UDiff = -UDiff
                U2 = U1
                U1 = U1 - UDiff
            END IF
            ! Compute the actual x-coordinate of the randomly chosen point.
            X = (NormalX(J) * Multiplier) + ((NormalX(J-1) - NormalX(J)) * INT(U1, KIND=DP))
            IF (UDiff >= NormalConvexMargin) THEN
                EXIT    ! The chosen point is way below the curve accept it.
            END IF
            ! Compute the actual y-coordinate of the randomly chosen point.
            Y = (NormalY(J) * Multiplier) + ((NormalY(J-1) - NormalY(J)) * INT(U2, KIND=DP))
            ! Now see how that y-coordinate compares to the curve
            IF (Y <= EXP(-0.5_DP*X*X)) EXIT ! The chosen point is below the curve accept it.
            ! Otherwise, we reject this sample and have to try again.
            U1 = SHIFTR(RNG%NextLong(), 1)
        END DO
    ELSE
        ! The overhang includes the inflection point, so the curve is both convex and concave
        DO
            U2 = SHIFTR(RNG%NextLong(), 1)
            ! Compute the actual x-coordinate of the randomly chosen point.
            X = (NormalX(J) * Multiplier) + ((NormalX(J-1) - NormalX(J)) * INT(U1, KIND=DP))
            ! Does the point lie below the curve?
            UDiff = U2 - U1
            IF (UDiff >= NormalConvexMargin) THEN
                EXIT    ! The chosen point is way below the curve accept it.
            END IF
            IF (UDiff <= -NormalConcaveMargin) THEN
                CYCLE   ! The chosen point is way above the curve reject it.
            END IF
            ! Compute the actual y-coordinate of the randomly chosen point.
            Y = (NormalY(J) * Multiplier) + ((NormalY(J-1) - NormalY(J)) * INT(U2, KIND=DP))
            ! Now see how that y-coordinate compares to the curve
            IF (Y <= EXP(-0.5_DP*X*X)) THEN
                EXIT    ! The chosen point is below the curve accept it.
            END IF
            ! Otherwise, we reject this sample and have to try again.
            U1 = SHIFTR(RNG%NextLong(), 1)
        END DO
    END IF
    
    RandNum = SignBit*X
    
    RETURN

END FUNCTION Default_NextGaussian

!******************************************************************************

MODULE FUNCTION Default_NextExponential(RNG) RESULT(RandNum)

!** PURPOSE OF THIS SUBROUTINE:
    ! To return  a nonnegative 64-bit floating point value pseudorandomly chosen
    ! from a exponential distribution whose mean is 1.
    ! The default implementation uses McFarland's fast modified ziggurat
    ! algorithm (largely table-driven, with rare cases handled by computation
    ! and rejection sampling). Walker's alias method for sampling a discrete
    ! distribution also plays a role.

    IMPLICIT NONE
        
!** SUBROUTINE ARGUMENT DECLARATIONS:
    CLASS(BaseRNG), INTENT(INOUT)   :: RNG      ! 'BaseRNG' object
    REAL(KIND=DP)                   :: RandNum  ! random number
    
!** SUBROUTINE INTERNAL VARIABLE DECLARATIONS:
    INTEGER(KIND=I8B)   :: U1, U2, UA, UDiff, I
    INTEGER(KIND=I4B)   :: J
    REAL(KIND=DP)       :: Extra, X, Y

! FLOW
    
    U1 = RNG%NextLong()
    ! Experimentation on a variety of machines indicates that it is overall much faster
    ! to do the following & and < operations on longs rather than first cast U1 to int
    ! (but then we need to cast to int before doing the array indexing operation).
    I = IAND(U1, ExponentialLayerMask)
    IF (I < ExponentialNumberOfLayers) THEN
        ! This is the fast path (occurring more than 98% of the time).  Make an early exit.
        RandNum = ExponentialX(I) * SHIFTR(U1, 1)
        RETURN
    END IF
    ! We didn't use the upper part of U1 after all.  We'll be able to use it later.
    Extra = 0.0_DP
    DO
        ! Use Walker's alias method to sample an (unsigned) integer J from a discrete
        ! probability distribution that includes the tail and all the ziggurat overhangs
        ! J will be less than ExponentialNumberOfLayers + 1.
        UA = RNG%NextLong()
        J = IAND(INT(UA, KIND=I4B), ExponentialAliasMask)
        IF (UA >= ExponentialAliasThreshold(J)) THEN
            J = IAND(ExponentialAliasMap(J), ExponentialSignCorrectionMask)
        END IF
        IF (J > 0) THEN ! Sample overhang J
            ! For the exponential distribution, every overhang is convex.
            ! At this point, the high-order bits of U1 have not been used yet,
            ! but we need the value in U1 to be positive.
            DO
                U2 = SHIFTR(RNG%NextLong(), 1)
                ! Does the point lie below the curve?
                UDiff = U2 - U1
                IF (UDiff < 0) THEN
                    ! We picked a point in the upper-right triangle.  None of those can be
                    ! accepted.  So remap the point into the lower-left triangle and try that.
                    ! In effect, we swap U1 and U2, and invert the sign of UDiff.
                    UDiff = -UDiff
                    U2 = U1
                    U1 = U1 - UDiff
                END IF
                ! Compute the actual x-coordinate of the randomly chosen point.
                X = (ExponentialX(J) * Multiplier) + ((ExponentialX(J-1) - ExponentialX(J)) * INT(U1, KIND=DP))
                IF (UDiff >= ExponentialConvexMargin) THEN
                    ! The chosen point is way below the curve accept it.
                    RandNum = X + Extra
                    RETURN
                END IF
                ! Compute the actual y-coordinate of the randomly chosen point.
                Y = (ExponentialY(J) * Multiplier) + ((ExponentialY(J-1) - ExponentialY(J)) * INT(U2, KIND=DP))
                ! Now see how that y-coordinate compares to the curve
                IF (Y <= EXP(-X)) THEN
                    ! The chosen point is below the curve accept it.
                    RandNum = X + Extra
                    RETURN
                END IF
                ! Otherwise, we reject this sample and have to try again.
                U1 = SHIFTR(RNG%NextLong(), 1)
            END DO
        END IF
        ! We are now committed to sampling from the tail.  We could do a recursive call
        ! and then add ExponentialX(0), but we save some time and stack space by using an iterative loop.
        Extra = Extra + ExponentialX0
        ! This is like the first five lines of this method, but IF it RETURNs, it first adds "Extra".
        U1 = RNG%NextLong()
        I = IAND(U1, ExponentialLayerMask)
        IF (I < ExponentialNumberOfLayers) THEN
            RandNum = ExponentialX(I) * SHIFTR(U1, 1) + Extra
            RETURN
        END IF
    END DO
    
    RETURN

END FUNCTION Default_NextExponential

!******************************************************************************

END SUBMODULE SubClass_Rng_Ziggurate
    
!******************************************************************************
